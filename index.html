<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal - Versão Avançada</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS para exportação Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF para exportação PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --primary-color: #007bff;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --info-color: #17a2b8;
            --purple-color: #6f42c1;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 1400px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .balance-indicator {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 2rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .balance-indicator:hover {
            transform: translateY(-5px);
        }

        .balance-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .balance-arrow {
            font-size: 2rem;
        }

        .positive { color: var(--success-color); }
        .negative { color: var(--danger-color); }
        .zero { color: var(--warning-color); }

        .form-section {
            background: var(--light-color);
            padding: 2rem;
            margin: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .form-section h3 {
            color: var(--dark-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .btn-custom {
            border-radius: 25px;
            padding: 10px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-success-custom {
            background: linear-gradient(135deg, var(--success-color), #1e7e34);
            color: white;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
        }

        .btn-warning-custom {
            background: linear-gradient(135deg, var(--warning-color), #e0a800);
            color: white;
        }

        .btn-info-custom {
            background: linear-gradient(135deg, var(--info-color), #138496);
            color: white;
        }

        .dashboard-section {
            padding: 2rem;
            margin: 2rem;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .top-categories {
            background: var(--light-color);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-badge {
            background: var(--primary-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .transactions-list {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }

        .transaction-item:hover {
            background: var(--light-color);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-type-receita {
            border-left: 4px solid var(--success-color);
        }

        .transaction-type-despesa {
            border-left: 4px solid var(--danger-color);
        }

        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        /* Novas classes para as melhorias */
        .goals-section {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .goal-item {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .progress-bar-custom {
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
            background: #e9ecef;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .progress-safe { background: linear-gradient(135deg, var(--success-color), #1e7e34); }
        .progress-warning { background: linear-gradient(135deg, var(--warning-color), #e0a800); }
        .progress-danger { background: linear-gradient(135deg, var(--danger-color), #c82333); }

        .smart-suggestions {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid var(--warning-color);
        }

        .suggestion-item {
            background: white;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }

        .suggestion-item:hover {
            background: var(--light-color);
            transform: translateX(5px);
        }

        .health-score {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2rem;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .score-excellent { background: linear-gradient(135deg, var(--success-color), #1e7e34); }
        .score-good { background: linear-gradient(135deg, #28a745, var(--warning-color)); }
        .score-fair { background: linear-gradient(135deg, var(--warning-color), #fd7e14); }
        .score-poor { background: linear-gradient(135deg, var(--danger-color), #c82333); }

        .nav-tabs-custom {
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 2rem;
        }

        .nav-tabs-custom .nav-link {
            border: none;
            color: var(--dark-color);
            font-weight: 600;
            padding: 15px 25px;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .nav-tabs-custom .nav-link:hover {
            background: var(--light-color);
            transform: translateY(-2px);
        }

        .nav-tabs-custom .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        .modal-custom .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-custom .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .balance-value {
                font-size: 2rem;
            }
            
            .form-section, .dashboard-section, .goals-section {
                margin: 1rem;
                padding: 1.5rem;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Cabeçalho -->
            <div class="header">
                <h1><i class="fas fa-chart-line me-3"></i>Controle Financeiro Avançado</h1>
                <p class="mb-0">Gerencie suas finanças com inteligência e precisão</p>
            </div>

            <!-- Navegação por Abas -->
            <div class="px-4 pt-3">
                <ul class="nav nav-tabs nav-tabs-custom" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
                            <i class="fas fa-exchange-alt me-2"></i>Transações
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="goals-tab" data-bs-toggle="tab" data-bs-target="#goals" type="button" role="tab">
                            <i class="fas fa-bullseye me-2"></i>Metas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                            <i class="fas fa-chart-area me-2"></i>Análises
                        </button>
                    </li>
                </ul>
            </div>

            <div class="tab-content" id="mainTabContent">
                <!-- Aba Dashboard -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                    <!-- Indicador de Saldo -->
                    <div class="balance-indicator fade-in">
                        <h4 class="mb-3">Saldo Atual</h4>
                        <div class="balance-value" id="balanceDisplay">
                            <span class="balance-arrow" id="balanceArrow">►</span>
                            <span id="balanceAmount">R$ 0,00</span>
                        </div>
                    </div>

                    <!-- Score de Saúde Financeira -->
                    <div class="dashboard-section">
                        <div class="health-score">
                            <h5><i class="fas fa-heartbeat me-2"></i>Saúde Financeira</h5>
                            <div class="score-circle score-excellent" id="healthScoreCircle">
                                <span id="healthScoreValue">85</span>
                            </div>
                            <p id="healthScoreText" class="mb-0">Excelente! Continue assim!</p>
                        </div>

                        <!-- Gráficos Principais -->
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <div class="chart-container">
                                    <h5><i class="fas fa-chart-pie me-2"></i>Despesas por Categoria</h5>
                                    <canvas id="expenseChart" width="400" height="400"></canvas>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="chart-container">
                                    <h5><i class="fas fa-chart-bar me-2"></i>Receitas x Despesas</h5>
                                    <canvas id="comparisonChart" width="400" height="400"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- TOP 3 Categorias -->
                        <div class="top-categories">
                            <h5><i class="fas fa-trophy me-2"></i>TOP 3 Maiores Gastos</h5>
                            <div id="topCategories">
                                <p class="text-muted">Nenhum dado disponível</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Transações -->
                <div class="tab-pane fade" id="transactions" role="tabpanel">
                    <!-- Formulário de Lançamentos -->
                    <div class="form-section fade-in">
                        <h3><i class="fas fa-plus-circle me-2"></i>Novo Lançamento</h3>
                        <form id="transactionForm">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="date" class="form-label">Data</label>
                                    <input type="date" class="form-control" id="date" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="type" class="form-label">Tipo</label>
                                    <select class="form-select" id="type" required>
                                        <option value="">Selecione...</option>
                                        <option value="receita">Receita</option>
                                        <option value="despesa">Despesa</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="category" class="form-label">Categoria</label>
                                    <select class="form-select" id="category" required>
                                        <option value="">Selecione o tipo primeiro</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="amount" class="form-label">Valor (R$)</label>
                                    <input type="number" class="form-control" id="amount" step="0.01" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="description" class="form-label">Descrição (opcional)</label>
                                    <input type="text" class="form-control" id="description" placeholder="Ex: Compra no supermercado">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success btn-custom btn-success-custom">
                                <i class="fas fa-plus-circle me-2"></i>Adicionar Lançamento
                            </button>
                        </form>

                        <!-- Sugestões Inteligentes -->
                        <div id="smartSuggestions" class="smart-suggestions" style="display: none;">
                            <h6><i class="fas fa-lightbulb me-2"></i>Sugestões Inteligentes</h6>
                            <div id="suggestionsList"></div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="form-section">
                        <h3><i class="fas fa-filter me-2"></i>Filtros</h3>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="monthFilter" class="form-label">Mês</label>
                                <select class="form-select" id="monthFilter">
                                    <option value="">Todos os meses</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="yearFilter" class="form-label">Ano</label>
                                <select class="form-select" id="yearFilter">
                                    <option value="">Todos os anos</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary btn-custom btn-primary-custom" onclick="exportToExcel()">
                                        <i class="fas fa-file-excel me-2"></i>Exportar Excel
                                    </button>
                                    <button class="btn btn-warning btn-custom btn-warning-custom" onclick="exportToPDF()">
                                        <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Transações -->
                    <div class="form-section">
                        <h3><i class="fas fa-list me-2"></i>Histórico de Transações</h3>
                        <div class="transactions-list" id="transactionsList">
                            <p class="text-muted text-center">Nenhuma transação encontrada</p>
                        </div>
                    </div>
                </div>

                <!-- Aba Metas -->
                <div class="tab-pane fade" id="goals" role="tabpanel">
                    <div class="goals-section">
                        <h3><i class="fas fa-bullseye me-2"></i>Metas Financeiras</h3>
                        
                        <!-- Orçamento Mensal -->
                        <div class="goal-item">
                            <h5><i class="fas fa-calendar-alt me-2"></i>Orçamento Mensal</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="monthlyBudget" class="form-label">Valor do Orçamento (R$)</label>
                                    <input type="number" class="form-control" id="monthlyBudget" step="0.01" placeholder="Ex: 3000.00">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Progresso do Mês</label>
                                    <div class="progress-bar-custom">
                                        <div class="progress-fill progress-safe" id="budgetProgress" style="width: 0%;">
                                            R$ 0,00 / R$ 0,00
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Metas por Categoria -->
                        <div class="goal-item">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-tags me-2"></i>Metas por Categoria</h5>
                                <button class="btn btn-primary btn-sm btn-custom btn-primary-custom" data-bs-toggle="modal" data-bs-target="#goalModal">
                                    <i class="fas fa-plus me-2"></i>Nova Meta
                                </button>
                            </div>
                            <div id="categoryGoals">
                                <p class="text-muted">Nenhuma meta definida</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Análises -->
                <div class="tab-pane fade" id="analytics" role="tabpanel">
                    <div class="dashboard-section">
                        <h3><i class="fas fa-chart-area me-2"></i>Análises Avançadas</h3>
                        
                        <!-- Tendência Mensal -->
                        <div class="chart-container">
                            <h5><i class="fas fa-chart-line me-2"></i>Tendência Mensal (Últimos 12 meses)</h5>
                            <canvas id="monthlyTrendChart" width="400" height="200"></canvas>
                        </div>

                        <!-- Evolução do Patrimônio -->
                        <div class="chart-container">
                            <h5><i class="fas fa-coins me-2"></i>Evolução do Patrimônio</h5>
                            <canvas id="wealthChart" width="400" height="200"></canvas>
                        </div>

                        <!-- Tendência por Categoria -->
                        <div class="chart-container">
                            <h5><i class="fas fa-chart-area me-2"></i>Tendência por Categoria (Últimos 6 meses)</h5>
                            <canvas id="categoryTrendChart" width="400" height="200"></canvas>
                        </div>

                        <!-- Projeções -->
                        <div class="chart-container">
                            <h5><i class="fas fa-crystal-ball me-2"></i>Projeções Financeiras</h5>
                            <canvas id="projectionChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nova Meta -->
    <div class="modal fade modal-custom" id="goalModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-bullseye me-2"></i>Nova Meta</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="goalForm">
                        <div class="mb-3">
                            <label for="goalCategory" class="form-label">Categoria</label>
                            <select class="form-select" id="goalCategory" required>
                                <option value="">Selecione uma categoria</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="goalAmount" class="form-label">Valor da Meta (R$)</label>
                            <input type="number" class="form-control" id="goalAmount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="goalPeriod" class="form-label">Período</label>
                            <select class="form-select" id="goalPeriod" required>
                                <option value="monthly">Mensal</option>
                                <option value="quarterly">Trimestral</option>
                                <option value="yearly">Anual</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-custom btn-primary-custom" onclick="addGoal()">Salvar Meta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Constantes
        const STORAGE_KEY = 'financialControl';

        // Categorias padrão
        const defaultCategories = {
            receita: ['Salário', 'Renda Extra', 'Dividendos', 'Aluguel', 'Outros'],
            despesa: ['Moradia', 'Supermercado', 'Transporte', 'Lazer', 'Assinaturas', 'Saúde', 'Educação', 'Outros']
        };

        // Palavras-chave para categorização inteligente
        const categoryKeywords = {
            'Moradia': ['aluguel', 'condominio', 'iptu', 'luz', 'agua', 'gas', 'internet', 'telefone'],
            'Supermercado': ['mercado', 'supermercado', 'feira', 'padaria', 'açougue', 'hortifruti'],
            'Transporte': ['posto', 'gasolina', 'uber', 'taxi', 'onibus', 'metro', 'estacionamento', 'pedagio'],
            'Lazer': ['cinema', 'teatro', 'restaurante', 'bar', 'viagem', 'hotel', 'parque'],
            'Assinaturas': ['netflix', 'spotify', 'amazon', 'youtube', 'assinatura', 'mensalidade'],
            'Saúde': ['farmacia', 'medico', 'hospital', 'dentista', 'exame', 'consulta', 'remedio'],
            'Educação': ['escola', 'faculdade', 'curso', 'livro', 'material escolar'],
            'Salário': ['salario', 'ordenado', 'pagamento', 'trabalho'],
            'Renda Extra': ['freelance', 'extra', 'bico', 'vendas']
        };

        // Variáveis globais para gráficos
        let expenseChart = null;
        let comparisonChart = null;
        let monthlyTrendChart = null;
        let categoryTrendChart = null;
        let wealthChart = null;
        let projectionChart = null;

        // Classe principal para gerenciar o controle financeiro
        class AdvancedFinancialControl {
            constructor() {
                this.transactions = this.loadData();
                this.categories = this.loadCategories();
                this.goals = this.loadGoals();
                this.monthlyBudget = this.loadMonthlyBudget();
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupDateDefault();
                this.updateDisplay();
                this.populateFilters();
                this.setupGoals();
                this.updateHealthScore();
            }

            setupEventListeners() {
                // Formulário de transação
                document.getElementById('transactionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTransaction();
                });

                // Mudança de tipo para atualizar categorias
                document.getElementById('type').addEventListener('change', (e) => {
                    this.updateCategoryOptions(e.target.value);
                });

                // Filtros
                document.getElementById('monthFilter').addEventListener('change', () => {
                    this.updateDisplay();
                });

                document.getElementById('yearFilter').addEventListener('change', () => {
                    this.updateDisplay();
                });

                // Descrição para sugestões inteligentes
                document.getElementById('description').addEventListener('input', (e) => {
                    this.showSmartSuggestions(e.target.value);
                });

                // Orçamento mensal
                document.getElementById('monthlyBudget').addEventListener('change', (e) => {
                    this.updateMonthlyBudget(parseFloat(e.target.value) || 0);
                });

                // Navegação por abas
                document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                    tab.addEventListener('shown.bs.tab', () => {
                        this.updateChartsOnTabChange();
                    });
                });
            }

            setupDateDefault() {
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                document.getElementById('date').value = `${year}-${month}-${day}`;
            }

            loadData() {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            }

            saveData() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(this.transactions));
            }

            loadCategories() {
                const categories = localStorage.getItem(STORAGE_KEY + '_categories');
                return categories ? JSON.parse(categories) : defaultCategories;
            }

            saveCategories() {
                localStorage.setItem(STORAGE_KEY + '_categories', JSON.stringify(this.categories));
            }

            loadGoals() {
                const goals = localStorage.getItem(STORAGE_KEY + '_goals');
                return goals ? JSON.parse(goals) : {};
            }

            saveGoals() {
                localStorage.setItem(STORAGE_KEY + '_goals', JSON.stringify(this.goals));
            }

            loadMonthlyBudget() {
                const budget = localStorage.getItem(STORAGE_KEY + '_budget');
                return budget ? parseFloat(budget) : 0;
            }

            saveMonthlyBudget() {
                localStorage.setItem(STORAGE_KEY + '_budget', this.monthlyBudget.toString());
            }

            addTransaction() {
                const date = document.getElementById('date').value;
                const type = document.getElementById('type').value;
                const category = document.getElementById('category').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const description = document.getElementById('description').value;

                if (!date || !type || !category || !amount) {
                    this.showNotification('Por favor, preencha todos os campos obrigatórios.', 'warning');
                    return;
                }

                const transaction = {
                    id: Date.now(),
                    date,
                    type,
                    category,
                    amount,
                    description
                };

                this.transactions.push(transaction);
                this.saveData();
                this.updateDisplay();
                this.clearForm();
                this.showNotification('Transação adicionada com sucesso!', 'success');
            }

            clearForm() {
                document.getElementById('transactionForm').reset();
                document.getElementById('category').innerHTML = '<option value="">Selecione o tipo primeiro</option>';
                document.getElementById('smartSuggestions').style.display = 'none';
                this.setupDateDefault();
            }

            updateCategoryOptions(type) {
                const categorySelect = document.getElementById('category');
                categorySelect.innerHTML = '<option value="">Selecione...</option>';

                if (type && this.categories[type]) {
                    this.categories[type].forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                }
            }

            showSmartSuggestions(description) {
                const suggestionsContainer = document.getElementById('smartSuggestions');
                const suggestionsList = document.getElementById('suggestionsList');

                if (!description || description.length < 3) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                const suggestions = this.getSmartSuggestions(description.toLowerCase());
                
                if (suggestions.length > 0) {
                    suggestionsList.innerHTML = suggestions.map(suggestion => `
                        <div class="suggestion-item" onclick="app.applySuggestion('${suggestion.type}', '${suggestion.category}')">
                            <strong>${suggestion.category}</strong> (${suggestion.type === 'receita' ? 'Receita' : 'Despesa'})
                        </div>
                    `).join('');
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            }

            getSmartSuggestions(description) {
                const suggestions = [];
                
                for (const [category, keywords] of Object.entries(categoryKeywords)) {
                    for (const keyword of keywords) {
                        if (description.includes(keyword)) {
                            const type = this.categories.receita.includes(category) ? 'receita' : 'despesa';
                            suggestions.push({ category, type });
                            break;
                        }
                    }
                }

                return suggestions.slice(0, 3); // Máximo 3 sugestões
            }

            applySuggestion(type, category) {
                document.getElementById('type').value = type;
                this.updateCategoryOptions(type);
                document.getElementById('category').value = category;
                document.getElementById('smartSuggestions').style.display = 'none';
            }

            updateBalanceDisplay() {
                const balance = this.calculateBalance();
                const balanceDisplay = document.getElementById('balanceDisplay');
                const balanceArrow = document.getElementById('balanceArrow');
                const balanceAmount = document.getElementById('balanceAmount');

                balanceAmount.textContent = this.formatCurrency(balance);

                // Remover classes anteriores
                balanceDisplay.classList.remove('positive', 'negative', 'zero');

                if (balance > 0) {
                    balanceDisplay.classList.add('positive');
                    balanceArrow.textContent = '▲';
                } else if (balance < 0) {
                    balanceDisplay.classList.add('negative');
                    balanceArrow.textContent = '▼';
                } else {
                    balanceDisplay.classList.add('zero');
                    balanceArrow.textContent = '►';
                }
            }

            calculateBalance() {
                return this.transactions.reduce((balance, transaction) => {
                    return transaction.type === 'receita' 
                        ? balance + transaction.amount 
                        : balance - transaction.amount;
                }, 0);
            }

            updateHealthScore() {
                const score = this.calculateHealthScore();
                const scoreCircle = document.getElementById('healthScoreCircle');
                const scoreValue = document.getElementById('healthScoreValue');
                const scoreText = document.getElementById('healthScoreText');

                scoreValue.textContent = score;

                // Remover classes anteriores
                scoreCircle.classList.remove('score-excellent', 'score-good', 'score-fair', 'score-poor');

                if (score >= 80) {
                    scoreCircle.classList.add('score-excellent');
                    scoreText.textContent = 'Excelente! Continue assim!';
                } else if (score >= 60) {
                    scoreCircle.classList.add('score-good');
                    scoreText.textContent = 'Bom! Você está no caminho certo.';
                } else if (score >= 40) {
                    scoreCircle.classList.add('score-fair');
                    scoreText.textContent = 'Regular. Há espaço para melhorias.';
                } else {
                    scoreCircle.classList.add('score-poor');
                    scoreText.textContent = 'Atenção! Revise seus gastos.';
                }
            }

            calculateHealthScore() {
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                
                const monthlyIncome = this.getMonthlyIncome(currentMonth, currentYear);
                const monthlyExpenses = this.getMonthlyExpenses(currentMonth, currentYear);
                
                if (monthlyIncome === 0) return 50; // Score neutro se não há receitas
                
                const savingsRate = ((monthlyIncome - monthlyExpenses) / monthlyIncome) * 100;
                const expenseRatio = (monthlyExpenses / monthlyIncome) * 100;
                
                let score = 100;
                
                // Penalizar se gastos > receitas
                if (expenseRatio > 100) {
                    score -= (expenseRatio - 100);
                }
                
                // Bonificar taxa de poupança
                if (savingsRate >= 20) {
                    score += 10;
                } else if (savingsRate >= 10) {
                    score += 5;
                } else if (savingsRate < 0) {
                    score -= 20;
                }
                
                // Verificar consistência (transações nos últimos 3 meses)
                const hasRecentTransactions = this.transactions.some(t => {
                    const transactionDate = new Date(t.date);
                    const threeMonthsAgo = new Date();
                    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                    return transactionDate >= threeMonthsAgo;
                });
                
                if (hasRecentTransactions) {
                    score += 5;
                }
                
                return Math.max(0, Math.min(100, Math.round(score)));
            }

            getMonthlyIncome(month, year) {
                return this.transactions
                    .filter(t => {
                        const date = new Date(t.date + 'T00:00:00');
                        return t.type === 'receita' && 
                               date.getMonth() + 1 === month && 
                               date.getFullYear() === year;
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
            }

            getMonthlyExpenses(month, year) {
                return this.transactions
                    .filter(t => {
                        const date = new Date(t.date + 'T00:00:00');
                        return t.type === 'despesa' && 
                               date.getMonth() + 1 === month && 
                               date.getFullYear() === year;
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
            }

            getCategoryExpenses(category, month, year) {
                return this.transactions
                    .filter(t => {
                        const date = new Date(t.date + 'T00:00:00');
                        return t.type === 'despesa' && 
                               t.category === category &&
                               date.getMonth() + 1 === month && 
                               date.getFullYear() === year;
                    })
                    .reduce((sum, t) => sum + t.amount, 0);
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(amount);
            }

            getFilteredTransactions() {
                const monthFilter = document.getElementById('monthFilter').value;
                const yearFilter = document.getElementById('yearFilter').value;

                return this.transactions.filter(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const transactionMonth = transactionDate.getMonth() + 1;
                    const transactionYear = transactionDate.getFullYear();

                    const monthMatch = !monthFilter || transactionMonth.toString() === monthFilter;
                    const yearMatch = !yearFilter || transactionYear.toString() === yearFilter;

                    return monthMatch && yearMatch;
                });
            }

            populateFilters() {
                const monthSelect = document.getElementById('monthFilter');
                const yearSelect = document.getElementById('yearFilter');

                // Limpar opções existentes (exceto a primeira)
                monthSelect.innerHTML = '<option value="">Todos os meses</option>';
                yearSelect.innerHTML = '<option value="">Todos os anos</option>';

                // Meses
                const months = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];

                months.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = month;
                    monthSelect.appendChild(option);
                });

                // Anos únicos das transações
                const years = [...new Set(this.transactions.map(t => new Date(t.date).getFullYear()))].sort((a, b) => b - a);
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            }

            updateTransactionsList() {
                const container = document.getElementById('transactionsList');
                const filteredTransactions = this.getFilteredTransactions();

                if (filteredTransactions.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">Nenhuma transação encontrada</p>';
                    return;
                }

                // Ordenar por data (mais recente primeiro)
                const sortedTransactions = filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                container.innerHTML = sortedTransactions.map(transaction => `
                    <div class="transaction-item transaction-type-${transaction.type}">
                        <div>
                            <strong>${transaction.category}</strong>
                            <br>
                            <small class="text-muted">${new Date(transaction.date + 'T00:00:00').toLocaleDateString('pt-BR')}</small>
                            ${transaction.description ? `<br><small>${transaction.description}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="fw-bold ${transaction.type === 'receita' ? 'text-success' : 'text-danger'}">
                                ${transaction.type === 'receita' ? '+' : '-'} ${this.formatCurrency(transaction.amount)}
                            </span>
                            <br>
                            <button class="btn btn-sm btn-outline-danger" onclick="app.removeTransaction(${transaction.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            removeTransaction(id) {
                if (confirm('Tem certeza que deseja excluir esta transação?')) {
                    this.transactions = this.transactions.filter(t => t.id !== id);
                    this.saveData();
                    this.updateDisplay();
                    this.showNotification('Transação removida com sucesso!', 'success');
                }
            }

            updateTopCategories() {
                const filteredTransactions = this.getFilteredTransactions();
                const expenses = filteredTransactions.filter(t => t.type === 'despesa');
                
                if (expenses.length === 0) {
                    document.getElementById('topCategories').innerHTML = '<p class="text-muted">Nenhum dado disponível</p>';
                    return;
                }

                // Agrupar por categoria e somar valores
                const categoryTotals = {};
                expenses.forEach(expense => {
                    categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
                });

                // Ordenar e pegar top 3
                const sortedCategories = Object.entries(categoryTotals)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3);

                const html = sortedCategories.map(([category, amount], index) => `
                    <div class="category-item">
                        <div>
                            <span class="category-badge">${index + 1}º</span>
                            <strong class="ms-2">${category}</strong>
                        </div>
                        <span class="fw-bold text-danger">${this.formatCurrency(amount)}</span>
                    </div>
                `).join('');

                document.getElementById('topCategories').innerHTML = html || '<p class="text-muted">Nenhum dado disponível</p>';
            }

            setupGoals() {
                // Configurar orçamento mensal
                document.getElementById('monthlyBudget').value = this.monthlyBudget;
                this.updateBudgetProgress();

                // Configurar metas por categoria
                this.updateCategoryGoals();

                // Popular dropdown de categorias no modal
                this.populateGoalCategories();
            }

            updateMonthlyBudget(amount) {
                this.monthlyBudget = amount;
                this.saveMonthlyBudget();
                this.updateBudgetProgress();
            }

            updateBudgetProgress() {
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                const monthlyExpenses = this.getMonthlyExpenses(currentMonth, currentYear);
                
                const progressBar = document.getElementById('budgetProgress');
                
                if (this.monthlyBudget > 0) {
                    const percentage = Math.min((monthlyExpenses / this.monthlyBudget) * 100, 100);
                    progressBar.style.width = percentage + '%';
                    progressBar.textContent = `${this.formatCurrency(monthlyExpenses)} / ${this.formatCurrency(this.monthlyBudget)}`;
                    
                    // Atualizar cor baseada na porcentagem
                    progressBar.classList.remove('progress-safe', 'progress-warning', 'progress-danger');
                    if (percentage >= 90) {
                        progressBar.classList.add('progress-danger');
                    } else if (percentage >= 75) {
                        progressBar.classList.add('progress-warning');
                    } else {
                        progressBar.classList.add('progress-safe');
                    }
                } else {
                    progressBar.style.width = '0%';
                    progressBar.textContent = 'Defina um orçamento mensal';
                }
            }

            updateCategoryGoals() {
                const container = document.getElementById('categoryGoals');
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                
                if (Object.keys(this.goals).length === 0) {
                    container.innerHTML = '<p class="text-muted">Nenhuma meta definida</p>';
                    return;
                }
                
                const goalsHtml = Object.entries(this.goals).map(([category, goal]) => {
                    const spent = this.getCategoryExpenses(category, currentMonth, currentYear);
                    const percentage = goal.amount > 0 ? Math.min((spent / goal.amount) * 100, 100) : 0;
                    
                    let progressClass = 'progress-safe';
                    if (percentage >= 90) {
                        progressClass = 'progress-danger';
                    } else if (percentage >= 75) {
                        progressClass = 'progress-warning';
                    }
                    
                    return `
                        <div class="goal-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6><i class="fas fa-tag me-2"></i>${category}</h6>
                                <button class="btn btn-sm btn-outline-danger" onclick="app.removeGoal('${category}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill ${progressClass}" style="width: ${percentage}%;">
                                    ${this.formatCurrency(spent)} / ${this.formatCurrency(goal.amount)}
                                </div>
                            </div>
                            <small class="text-muted">${percentage.toFixed(1)}% da meta ${goal.period === 'monthly' ? 'mensal' : goal.period}</small>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = goalsHtml;
            }

            populateGoalCategories() {
                const select = document.getElementById('goalCategory');
                select.innerHTML = '<option value="">Selecione uma categoria</option>';
                
                // Adicionar categorias de despesa
                this.categories.despesa.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
            }

            addGoal() {
                const category = document.getElementById('goalCategory').value;
                const amount = parseFloat(document.getElementById('goalAmount').value);
                const period = document.getElementById('goalPeriod').value;

                if (!category || !amount || !period) {
                    this.showNotification('Por favor, preencha todos os campos.', 'warning');
                    return;
                }

                this.goals[category] = { amount, period };
                this.saveGoals();
                this.updateCategoryGoals();
                this.showNotification('Meta adicionada com sucesso!', 'success');

                // Fechar modal e limpar formulário
                const modal = bootstrap.Modal.getInstance(document.getElementById('goalModal'));
                modal.hide();
                document.getElementById('goalForm').reset();
            }

            removeGoal(category) {
                if (confirm(`Tem certeza que deseja remover a meta para ${category}?`)) {
                    delete this.goals[category];
                    this.saveGoals();
                    this.updateCategoryGoals();
                    this.showNotification('Meta removida com sucesso!', 'success');
                }
            }

            updateDisplay() {
                this.updateBalanceDisplay();
                this.updateTransactionsList();
                this.updateTopCategories();
                this.updateCharts();
                this.updateBudgetProgress();
                this.updateCategoryGoals();
                this.updateHealthScore();
            }

            updateCharts() {
                this.updateExpenseChart();
                this.updateComparisonChart();
            }

            updateChartsOnTabChange() {
                // Aguardar um pouco para garantir que a aba esteja visível
                setTimeout(() => {
                    this.updateMonthlyTrendChart();
                    this.updateCategoryTrendChart();
                    this.updateWealthChart();
                    this.updateProjectionChart();
                }, 100);
            }

            updateExpenseChart() {
                const filteredTransactions = this.getFilteredTransactions();
                const expenses = filteredTransactions.filter(t => t.type === 'despesa');
                
                const ctx = document.getElementById('expenseChart').getContext('2d');
                
                if (expenseChart) {
                    expenseChart.destroy();
                }

                if (expenses.length === 0) {
                    expenseChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Nenhum dado'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#e9ecef']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                    return;
                }

                // Agrupar despesas por categoria
                const categoryTotals = {};
                expenses.forEach(expense => {
                    categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
                });

                const labels = Object.keys(categoryTotals);
                const data = Object.values(categoryTotals);
                const colors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ];

                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(context.parsed);
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateComparisonChart() {
                const filteredTransactions = this.getFilteredTransactions();
                
                const totalReceitas = filteredTransactions
                    .filter(t => t.type === 'receita')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalDespesas = filteredTransactions
                    .filter(t => t.type === 'despesa')
                    .reduce((sum, t) => sum + t.amount, 0);

                const ctx = document.getElementById('comparisonChart').getContext('2d');
                
                if (comparisonChart) {
                    comparisonChart.destroy();
                }

                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Receitas', 'Despesas'],
                        datasets: [{
                            label: 'Valor (R$)',
                            data: [totalReceitas, totalDespesas],
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderColor: ['#1e7e34', '#c82333'],
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateMonthlyTrendChart() {
                const ctx = document.getElementById('monthlyTrendChart');
                if (!ctx) return;
                
                if (monthlyTrendChart) {
                    monthlyTrendChart.destroy();
                }

                // Obter dados dos últimos 12 meses
                const monthlyData = this.getMonthlyTrendData();

                monthlyTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: monthlyData.labels,
                        datasets: [
                            {
                                label: 'Receitas',
                                data: monthlyData.receitas,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Despesas',
                                data: monthlyData.despesas,
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Saldo',
                                data: monthlyData.saldo,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(context.parsed.y)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            getMonthlyTrendData() {
                const now = new Date();
                const labels = [];
                const receitas = [];
                const despesas = [];
                const saldo = [];

                for (let i = 11; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    
                    labels.push(date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
                    
                    const monthlyIncome = this.getMonthlyIncome(month, year);
                    const monthlyExpenses = this.getMonthlyExpenses(month, year);
                    
                    receitas.push(monthlyIncome);
                    despesas.push(monthlyExpenses);
                    saldo.push(monthlyIncome - monthlyExpenses);
                }

                return { labels, receitas, despesas, saldo };
            }

            updateCategoryTrendChart() {
                const ctx = document.getElementById('categoryTrendChart');
                if (!ctx) return;
                
                if (categoryTrendChart) {
                    categoryTrendChart.destroy();
                }

                // Obter tendências das principais categorias
                const trendData = this.getCategoryTrendData();

                categoryTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: trendData.labels,
                        datasets: trendData.datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            getCategoryTrendData() {
                const now = new Date();
                const labels = [];
                const categoryData = {};
                const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];

                // Obter últimos 6 meses
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push(date.toLocaleDateString('pt-BR', { month: 'short' }));
                }

                // Obter principais categorias de despesa
                const topCategories = this.getTopExpenseCategories(5);

                topCategories.forEach((category, index) => {
                    categoryData[category] = {
                        label: category,
                        data: [],
                        borderColor: colors[index],
                        backgroundColor: colors[index] + '20',
                        tension: 0.4
                    };

                    for (let i = 5; i >= 0; i--) {
                        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const amount = this.getCategoryExpenses(category, date.getMonth() + 1, date.getFullYear());
                        categoryData[category].data.push(amount);
                    }
                });

                return {
                    labels,
                    datasets: Object.values(categoryData)
                };
            }

            getTopExpenseCategories(limit = 5) {
                const categoryTotals = {};
                
                this.transactions
                    .filter(t => t.type === 'despesa')
                    .forEach(t => {
                        categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                    });

                return Object.entries(categoryTotals)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, limit)
                    .map(([category]) => category);
            }

            updateWealthChart() {
                const ctx = document.getElementById('wealthChart');
                if (!ctx) return;
                
                if (wealthChart) {
                    wealthChart.destroy();
                }

                const wealthData = this.getWealthEvolutionData();

                wealthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: wealthData.labels,
                        datasets: [{
                            label: 'Patrimônio Acumulado',
                            data: wealthData.values,
                            borderColor: '#6f42c1',
                            backgroundColor: 'rgba(111, 66, 193, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            getWealthEvolutionData() {
                const now = new Date();
                const labels = [];
                const values = [];
                let accumulatedWealth = 0;

                for (let i = 11; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    
                    labels.push(date.toLocaleDateString('pt-BR', { month: 'short' }));
                    
                    const monthlyIncome = this.getMonthlyIncome(month, year);
                    const monthlyExpenses = this.getMonthlyExpenses(month, year);
                    
                    accumulatedWealth += (monthlyIncome - monthlyExpenses);
                    values.push(accumulatedWealth);
                }

                return { labels, values };
            }

            updateProjectionChart() {
                const ctx = document.getElementById('projectionChart');
                if (!ctx) return;
                
                if (projectionChart) {
                    projectionChart.destroy();
                }

                const projectionData = this.getProjectionData();

                projectionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: projectionData.labels,
                        datasets: [
                            {
                                label: 'Histórico',
                                data: projectionData.historical,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Projeção',
                                data: projectionData.projection,
                                borderColor: '#fd7e14',
                                backgroundColor: 'rgba(253, 126, 20, 0.1)',
                                borderDash: [5, 5],
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            getProjectionData() {
                const now = new Date();
                const labels = [];
                const historical = [];
                const projection = [];

                // Dados históricos (últimos 6 meses)
                let accumulatedWealth = 0;
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    
                    labels.push(date.toLocaleDateString('pt-BR', { month: 'short' }));
                    
                    const monthlyIncome = this.getMonthlyIncome(month, year);
                    const monthlyExpenses = this.getMonthlyExpenses(month, year);
                    
                    accumulatedWealth += (monthlyIncome - monthlyExpenses);
                    historical.push(accumulatedWealth);
                    projection.push(null);
                }

                // Calcular média dos últimos 3 meses para projeção
                const recentMonths = historical.slice(-3);
                const avgGrowth = recentMonths.reduce((sum, val, idx, arr) => {
                    if (idx === 0) return 0;
                    return sum + (val - arr[idx - 1]);
                }, 0) / (recentMonths.length - 1);

                // Projeção para os próximos 6 meses
                let lastValue = accumulatedWealth;
                for (let i = 1; i <= 6; i++) {
                    const futureDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
                    labels.push(futureDate.toLocaleDateString('pt-BR', { month: 'short' }));
                    
                    lastValue += avgGrowth;
                    historical.push(null);
                    projection.push(lastValue);
                }

                return { labels, historical, projection };
            }

            showNotification(message, type = 'info') {
                // Criar elemento de notificação
                const notification = document.createElement('div');
                notification.className = `alert alert-${type} notification fade-in`;
                notification.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                `;

                // Adicionar ao body
                document.body.appendChild(notification);

                // Remover automaticamente após 5 segundos
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
        }

        // Funções globais
        function exportToExcel() {
            const filteredTransactions = app.getFilteredTransactions();
            
            if (filteredTransactions.length === 0) {
                app.showNotification('Nenhuma transação para exportar.', 'warning');
                return;
            }

            // Preparar dados para exportação
            const exportData = filteredTransactions.map(transaction => ({
                'Data': new Date(transaction.date).toLocaleDateString('pt-BR'),
                'Tipo': transaction.type === 'receita' ? 'Receita' : 'Despesa',
                'Categoria': transaction.category,
                'Valor': transaction.amount,
                'Descrição': transaction.description || ''
            }));

            // Criar workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Adicionar worksheet ao workbook
            XLSX.utils.book_append_sheet(wb, ws, "Transações");
            
            // Salvar arquivo
            XLSX.writeFile(wb, `controle_financeiro_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            app.showNotification('Arquivo Excel exportado com sucesso!', 'success');
        }

        function exportToPDF() {
            const filteredTransactions = app.getFilteredTransactions();
            
            if (filteredTransactions.length === 0) {
                app.showNotification('Nenhuma transação para exportar.', 'warning');
                return;
            }

            // Criar novo documento PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Título
            doc.setFontSize(20);
            doc.text('Relatório Financeiro', 20, 20);

            // Data do relatório
            doc.setFontSize(12);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);

            // Resumo
            const totalReceitas = filteredTransactions
                .filter(t => t.type === 'receita')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalDespesas = filteredTransactions
                .filter(t => t.type === 'despesa')
                .reduce((sum, t) => sum + t.amount, 0);

            const saldo = totalReceitas - totalDespesas;

            doc.text(`Total de Receitas: ${app.formatCurrency(totalReceitas)}`, 20, 45);
            doc.text(`Total de Despesas: ${app.formatCurrency(totalDespesas)}`, 20, 55);
            doc.text(`Saldo: ${app.formatCurrency(saldo)}`, 20, 65);

            // Lista de transações
            doc.text('Transações:', 20, 80);
            
            let yPosition = 90;
            filteredTransactions.slice(0, 30).forEach((transaction, index) => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                const date = new Date(transaction.date).toLocaleDateString('pt-BR');
                const type = transaction.type === 'receita' ? 'R' : 'D';
                const text = `${date} | ${type} | ${transaction.category} | ${app.formatCurrency(transaction.amount)}`;
                
                doc.setFontSize(10);
                doc.text(text, 20, yPosition);
                yPosition += 10;
            });

            // Salvar PDF
            doc.save(`relatorio_financeiro_${new Date().toISOString().split('T')[0]}.pdf`);
            
            app.showNotification('Arquivo PDF exportado com sucesso!', 'success');
        }

        function addGoal() {
            app.addGoal();
        }

        // Inicializar aplicação
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new AdvancedFinancialControl();
        });
    </script>
</body>
</html>

